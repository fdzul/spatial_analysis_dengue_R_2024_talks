---
format: 
  revealjs:
    code-block-bg: true
    code-block-background: true
    code-copy: true
    chalkboard: true
    highlight-style: github
    slide-number: c/t
    logo: logo_cenaprece.jpeg
    footer: "[hub.com/fdzul](https://github.com/fdzul)"
    center-title-slide: true
---

<h2> Hotspots del Vector del Dengue
<br> en R
</h2>

<h2>

</h2>

<hr>

<br>


<h3>Dr. Felipe Dzul Manzanilla</h3>

<h3>Dr. Fabián Correa-Morales</h3>

<h3>

</h3>
<br>
<h4>Date: 2024-02-01 </h4>

<h4> Update: 2024-02-01</h4>

<br>

<h4>


![](logo_curso_2024.png){.absolute top="170" left="650" width="450"}


## [Temario]{style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

- Conceptos Básico del Análisis Geoestadístico
- Modelo del Análisis Geoestadístico

## Conceptos $\color{#2ECC40}s_{\color{#2ECC40}i}$, $\color{#2ECC40}D$, $\color{#2ECC40}Y_{\color{#2ECC40}{si}}$ & $\color{#2ECC40}U_{\color{#2ECC40}{si}}$
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

:::: {.columns}

::: {.column style="width: 50%"}
![](guadalajara_sample.jpg)
:::

::: {.column style="width: 50%; font-size: 65%"}
$\color{#2ECC40}s_{\color{#2ECC40}i}$ sitios de colecta con coordenadas geográficas (longitud. latitud).
&nbsp;

$\color{#2ECC40}D$ area de estudio (zona metropolitana de Guadalajara).
&nbsp;

$\color{#2ECC40}Y_{\color{#2ECC40}{si}}$ es la variable de respuesta (Número de Huevos por Ovitrampa o Manzana).
&nbsp;

$\color{#2ECC40}Y_{\color{#2ECC40}{si}}$ tiene una distribución (binomial negativa ó zibn).
&nbsp;

$\color{#2ECC40}U_{\color{#2ECC40}{si}}$ el efecto espacial & el proceso ocurre en un campo gaussiano continuo (Gaussian Field).
:::

:::


## [Modelo del Análisis Geoestadístico]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

:::: {.columns}

::: {.column style="width: 50%;font-size: 70%"}
Modelo sin correlación espacial
\begin{align*}
Huevos & = \beta{_0} + \beta x + \epsilon{_i} \\
\beta{_0} & = intercepto \\
\beta x & =  pendiente \\
\epsilon{_i} & = error \\
\epsilon{_i} &\sim {\sf Norm}(0, \sigma^2) \\
\end{align*}

Modelo con efecto espacial
\begin{align*}
Huevos & = \beta{_0} + \beta x + u{_i}+\epsilon{_i} \\
Huevos & = \beta{_0} + u{_i}+\epsilon{_i} \\
u{_i} & = efecto espacial \\
u{_i} &\sim {\sf GF}(0, \sum) \\
\end{align*}
:::

::: {.column style="width: 50%; font-size: 65%"}
Cuando D es regular
&nbsp;

Se usa Gausian Makovian RF (GMRF) para aproximar la matriz de covarianzas

&nbsp;

Cuando D es irregular
&nbsp;
&nbsp;

Se usa SPDE & Elemento Finito para aproximar la matriz de covarianzas

:::

:::


## [SPDE & Elemento Finito de INLA]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

:::: {.columns}

::: {.column style="width: 40%;font-size: 70%"}
SPDE
&nbsp;

$$(K^2-\Delta)^{a/2}U(s) = W(s)$$

Elemento Finito
&nbsp;

$$u(s) = \sum_{i=1}^{G} \alpha{_k}(s{_i})W{_k}$$
:::

::: {.column style="width: 60%"}

```{r}
set.seed(123)
s <- cbind(x1 = runif(5),
           y1 = runif(5))

mesh <- fmesher::fm_mesh_2d_inla(loc = s, 
                                 max.edge = 1)
ggplot2::ggplot() +
    inlabru::gg(mesh) +
    ggplot2::geom_point(data = as.data.frame(s),
                        ggplot2::aes(x = x1,
                                     y = y1),
                        col = "red",
                        size = 3)
# Numero de G
mesh$n
```

:::

:::


## [Elemento Finito, SPDE & Cálculo de $\alpha{_k}$]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

:::: {.columns}

::: {.column style="width: 50%;font-size: 70%"}
![Figure 2.8. Kraisky et al 2019](https://becarioprecario.bitbucket.io/spde-gitbook/figs/spde-intro-interp2d-1.png "Figure 2.8. Kraisky et al 2019")
:::

::: {.column style="width: 50%; font-size: 60%"}
-  Coordenadas en los vértices
&nbsp;

   Sí $s{_i}$ caé en el vértice 1, el resto 0.
   $u(s) = w{_k}$

-  Cordenadas dentro del Triángulo
&nbsp;

   Sí $s{_i}$ caé dentro del triángulo
   se ponderan los tres puntos
   $$u(s) = \sum_{i=1}^{G} \alpha{_k}(s{_i})W{_k}$$
   
   $$0.17 * W{_1} + 0.54 * W{_3} + 0.29 * W{_3}$$

- Coordenadas sobre un borde
&nbsp;
  
  Sí $s{_i}$ caé en el borde
  se ponderan los dos valores 
  
  $$u(s) = \sum_{i=1}^{G} \alpha{_k}(s{_i})W{_k}$$


:::

:::


## [Análisis Geoestadístico de Ovitrampas en R]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

::: {.panel-tabset}
## Mesh de Guadalajara
```{r}
#| echo: false
#| output: true
path_ovitraps <- "/Users/fdzul/Library/CloudStorage/OneDrive-Personal/datasets/CENAPRECE/2023/14_jalisco"
path_coord <- paste(path_ovitraps,"DescargaOvitrampasMesFco.txt", sep = "/" )
x <- deneggs::eggs_hotspots(path_lect = path_ovitraps,
                            cve_ent = "14",
                            locality  = c("Guadalajara", "Zapopan",
                                          "Tlaquepaque", "Tonalá"),
                            path_coord = path_coord,
                            longitude  = "Pocision_X",
                            latitude =  "Pocision_Y",
                            aproximation = "gaussian",
                            integration = "eb",
                            fam = "zeroinflatednbinomial1",
                            k = 80,
                            palette_vir  = "magma",
                            leg_title = "Huevos",
                            plot = FALSE,
                            hist_dataset = FALSE,
                            sem = 41,
                            var = "eggs",
                            cell_size = 2000,
                            alpha = .99)

ggplot2::ggplot() +
    inlabru::gg(x$mesh) +
    ggplot2::geom_point(data = x$data,
                        ggplot2::aes(x = x$data$Pocision_X,
                                     y = x$data$Pocision_Y),
                        col = "red")
```

## Zoom Mesh de Guadalajara
```{r}
#| echo: false
#| output: true
ggplot2::ggplot() +
    inlabru::gg(x$mesh) +
    ggplot2::geom_point(data = x$data,
                        ggplot2::aes(x = x$data$Pocision_X,
                                     y = x$data$Pocision_Y),
                        col = "red") +
    ggplot2::coord_sf(xlim = c(-103.30, -103.28),
                      ylim = c(20.60, 20.61))
```

:::


## [Análisis Geoestadístico de Ovitrampas en R]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

:::: {.columns}

::: {.column style="width: 40%;font-size: 70%"}
![](https://github.com/fdzul/deneggs/blob/master/man/figures/logo.png?raw=true)
:::

::: {.column style="width: 60%; font-size: 60%"}
En analisis geoestadístico de la vigilancia entomológica con ovitrampas se realiza con el paquete [deneggs](https://fdzul.github.io/deneggs/). El paquete es parte del dengueverse & tiene tres funciones para realizar la predicción del número de huevos en áreas donde no se colectó de una localidad.

   - [spde_pred_map](https://fdzul.github.io/deneggs/reference/spde_pred_map.html)
   - [eggs_hotspots](https://fdzul.github.io/deneggs/reference/eggs_hotspots.html)
   - [eggs_hotspots_week](https://fdzul.github.io/deneggs/reference/eggs_hotspots_week.html)

La función [spde_pred_map](https://fdzul.github.io/deneggs/reference/spde_pred_map.html) tiene la característica de realizar el analisis geoestadístico por semana con siete diferentes distribuciones (poisson, zeroinflatedpoisson0, zeroinflatedpoisson1, nbinomial, nbinomial2, zeroinflatednbinomial0, & zeroinflatednbinomial1). La función [eggs_hotspots](https://fdzul.github.io/deneggs/reference/eggs_hotspots.html) realiza el análisis por semana con solo una distribución y la función [eggs_hotspots_week](https://fdzul.github.io/deneggs/reference/eggs_hotspots_week.html) realiza el análisis para todas las semanas del año.

:::

:::

## [Análisis Geoestadístico de Ovitrampas en R]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

-   1. Instalar el paquete **INLA**. 

-   2. Instalar el paquete **deneggs**. 
&nbsp;

-   3. Definir la ruta de los archivos de las lecturas y las coordenadas.
&nbsp;

-   4. Definir la localidad de interes y la clave del estado.
&nbsp;

-   5. Definir el resto de argumenos.

-   6. Correr una de las tres  funciones.

## [Argumentos de las funciones de deneggs]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

```{r echo=FALSE}
tibble::tibble(argumento = c("path_lect", "path_coord", "year","locality",  "cve_ent",
                             "leg_title", "fam", "alpha", "plot", "aproximation"),
    definicion = c("Ruta de ovitrampas", "Ruta de la coordenadas", "Año a analizar", "localidad", "Clave del Estado",
                   "Título de la leyenda", "Nombre de la Distribución", "Nivel de Significancia", "Valor lógico para visualizar el mesh", "Es el método de aproximación para calcular los hiperparametros y valores marginales. Las opciones son gaussian, simplified.laplace & laplace")) |>
    reactable::reactable(defaultPageSize = 10,
                         theme = reactablefmtr::flatly(),
                         filterable = FALSE,
                         striped = TRUE,
                         #minRows = 10,
                         resizable = TRUE, 
                         wrap = TRUE, 
                         bordered = TRUE)
```



## [Dios Botic]{style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

-   ***Bio*** : [https://fdzul.github.io/web_site_fadm/]()

-   ***email*** : [felipe.dzul.m\@gmail.com]()

-   ***celular*** : [9999580167]()

-   ***slides***: [https://calm-hummingbird-41cb33.netlify.app/talks/hotspots_eggs_R/#/](https://calm-hummingbird-41cb33.netlify.app/talks/hotspots_eggs_R/#/)
