---
format: 
  revealjs:
    code-block-bg: true
    code-block-background: true
    code-copy: true
    chalkboard: true
    highlight-style: github
    slide-number: c/t
    logo: logo_cenaprece.jpeg
    footer: "[github.com/fdzul](https://github.com/fdzul)"
    center-title-slide: true
---

<h2>Análisis Espacial del Dengue en R
<br> para focalizar el control del vectores
</h2>

<h2>

</h2>

<hr>

<br>


<h3>Dr. Felipe Dzul Manzanilla</h3>

<h3>Dr. Fabián Correa-Morales</h3>

<h3>

</h3>
<br>
<h4>Date: 2024-01-24 </h4>

<h4> Update: 2024-01-26</h4>

<br>

<h4>


![](logo_curso_2024.png){.absolute top="170" left="650" width="450"}

## [Temario]{style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

- Ciclo del vida del programa de Dengue
- Análisis Espacial de la Transmisión de Dengue
  - Hotspots de la Transmisión de Dengue
  - Cadenas de Transmisión Activa
  - Modelo Log-Gaussian Cox Process
  - Mapas de Calor


## [Temario]{style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

- Análisis Espacial del Vector del Dengue.
  - Análisis Geoestadístico con INLA
  - Algoritmo del Análisis Geoestadístico 

- Modelo Estratégico de Focalización del Dengue

## [Temario]{style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

- Análisis Espacial del Dengue en México en R
- Hotspots de la Transmisión
- Cadenas de Transmisión Activa
- Modelo Espacial ***Log-Gaussian Cox Process***
- Análisis Geoestadístico del Vector del Dengue
- Desarrollo del dengueverse y dashboard


## [Ciclo del Vida del Programa del Dengue]{style="color:#003300;" .r-fit-text}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

```{r, dpi=300,echo=FALSE, fig.align ="center", out.height="100%",out.width = "100%"}
DiagrammeR::grViz("digraph {

  # graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = circle, style = filled, color = grey,
  fixedsize = true, width = 2] 
  edge [color = grey, arrowhead = normal, arrowtail = dot]
  
  
  ###########
  prog_den [label = 'Programa de Dengue',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']
  
  # epidemiology
  epi [label = 'Vigilancia Epidemiológica',  fillcolor = '#0F9D58', color = 'white', fontcolor = 'white']
  
  brote [label = 'Brote',  fillcolor = 'DarkOrange', color = 'white', fontcolor = 'black']
  cp [label = 'Control de Probables',  fillcolor = 'DarkOrange', color = 'white', fontcolor = 'black']
  node [shape = circle, style = filled, color = grey] 
  
  
  node [shape = circle, style = filled, color = grey] 
  
  
  hotspots [label = 'Hotspots',  fillcolor = '#DB4437', color = 'white', fontcolor = 'white']
  cadenas [label = 'Cadenas de Transmisión',  fillcolor = '#DB4437', color = 'white', fontcolor = 'white']
  
  heatmap [label = 'Mapas de Calor',  fillcolor = '#DB4437', color = 'white', fontcolor = 'white']
  node [shape = circle, style = filled, color = grey] 
  
  
  #### entomology
  ent [label = 'Vigilancia Entomológica',  fillcolor = '#0F9D58', color = 'white', fontcolor = 'white']
  ovitraps [label = 'Ovitrampas',  fillcolor = 'DarkOrange', color = 'white', fontcolor = 'white']
  adult [label = 'Colecta de Adultos*',  fillcolor = 'DarkOrange', color = 'white', fontcolor = 'white']
  enc_ver [label = 'Encuesta Verificación',  fillcolor = 'DarkOrange', color = 'white', fontcolor = 'white']
  
  
  plat [label = 'Plataforma',  fillcolor = 'DarkOrange', color = 'white', fontcolor = 'black']
  
  #########
 
  ###
  ind [label = 'Indicadores',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
  
  ###################
  prog_den -> {epi, ent}[penwidth = 4]
  
  
  epi -> {brote[arrowhead = crow, arrowtail = box, color = 'Maroon']
  cp[arrowhead = crow, arrowtail = box, color = 'Maroon']
  hotspots[arrowhead = crow, arrowtail = box, color = 'Maroon']
  cadenas[arrowhead = crow, arrowtail = box, color = 'Maroon']
  heatmap[arrowhead = crow, arrowtail = box, color = 'Maroon']
  
  
  } -> plat[penwidth = 4]
  epi -> {}[penwidth = 4]
  ent -> {adult, ovitraps, enc_ver} -> plat[penwidth = 4]  
  plat -> ind[penwidth = 4]
 

 
 
 
  }", 
  height = 550)

```

## [Análisis Espacial de la Transmisión del Dengue]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

```{r, echo=FALSE, out.width='100%', fig.align='center'}
DiagrammeR::grViz("digraph {
                  # graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = rectangle, 
  style = filled, 
  color = grey, 
  nodesep = .5,
  fixedsize = true, 
  width = 2.5] 
  
  # edge definition
  edge [color = grey, arrowhead = normal, arrowtail = dot]
  
  ##### epidemiological data
  
  epi [label = 'Vigilancia Epidemiológica',  fillcolor =  '#DB4437', color = 'white', fontcolor = 'white']
  data_historic [label = 'Datos Históricos',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  data_datos_actuales [label = 'Datos Actuales',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  data_acumulados [label = 'Datos Acumulados',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  data_trans_activa [label = 'Transmisión Activa',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  
  
  ##### Spatial Data
  
  areal [label = 'Areal Data',  fillcolor =  '#0F9D58', color = 'white', fontcolor = 'white']
  pp_data [label = 'Point Pattern Data',  fillcolor =  ' #0F9D58', color = 'white', fontcolor = 'white']
  
  
 
 # Análisis 
 hotspots [label = 'Hotspots Analysis',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 cadenas [label = 'Cadenas de Transmisión',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 cluster_ana [label = 'Cluster Analysis',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 lgcp [label = 'Spatial LGCP',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 
 heatmap [label = 'Mapas de Calor',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 
 
 # software
 
 geoda [label = 'Geoda',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']
 cluster_s [label = 'ClusterSeer',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']
 satscan [label = 'SatScan',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']
 
 r_rstudio [label = 'R & RStudio',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']

  denhotspot [label = 'denhotspots Package',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white'] 
 
 ##### define the relation
 
 epi -> {data_historic  data_datos_actuales}
 data_historic -> areal -> hotspots -> geoda
 data_datos_actuales -> {data_acumulados, data_trans_activa} -> pp_data -> {cadenas lgcp cluster_ana heatmap}
 cadenas -> cluster_s
 cluster_ana -> satscan
 
 {geoda cluster_s satscan lgcp} -> r_rstudio -> denhotspot
 
}")

```


## [Hotspots de la Transmisión del Dengue]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

:::: {.columns}

::: {.column style="width: 50%; font-size: 60%"}
1. Bajar las bases de datos del [SINAVE](https://www.sinave.gob.mx/).
2. Geocodificar las bases.
3. Bajar los shapefile del [INEGI](https://www.inegi.org.mx/).
4. Seleccionar la localidad de interes y extraer los AGEBs.
5. Contar el número de casos por AGEB.
6. Cálcular el Z-score de los casos.
7. Generar la matriz de adjacencias.
8. Cálcular el estadístico espacial local Getis&Ord $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$.
9. Realizar la la corrección de Bonferroni.
10. Cálcular los hotspots.
11. Visualizar los hotspots.
:::

::: {.column style="width: 50%"}

```{r, dpi=300,echo=FALSE, fig.align ="center", out.width = "100%"}
DiagrammeR::grViz("digraph {

  # graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = rectangle, style = filled, color = grey] 
  
  # flowchart for hotspots
  sinave [label = 'SINAVE',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
  denv [label = 'Bases de DENV',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
  geocode [label = 'Geocodificación',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
  cases_ageb [label = 'Casos por AGEBs']
  z_score [label = 'Z-score']
  gi [label = 'Estadístico Espacial Local (Gi*)']
  bonferroni [label = 'Corrección de Bonferroni']
  hotspots [label = 'Hotspots', style = filled, color = orange]
  
  # flow chart for inegi
  inegi [label = 'INEGI', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  loc [label = 'Localidades Shapefile', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  ageb [label = 'AGEB Shapefile', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  loc_esp [label = 'Localidad de Ínteres', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  ageb_esp [label = 'AGEBs de la Localidad de Ínteres', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  mat [label = 'Matriz de Adjacencias', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  
  # edge definitions with the node IDs
  edge [color = black]
  sinave -> denv -> geocode -> cases_ageb -> z_score -> gi -> bonferroni -> hotspots 
  inegi -> {ageb, loc}
  loc -> loc_esp -> ageb_esp
  ageb -> ageb_esp
  ageb_esp -> mat
  mat -> cases_ageb 
 
  }", 
  height = 550)

```
:::

::::

::: aside
[Dzul-Manzanilla et al 2021](https://www.thelancet.com/journals/lanplh/article/PIIS2542-5196(21)00030-9/fulltext)
:::


## [Estadístico Espacial Local $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$ (Hotspots)]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

::: {.column style="width: 100%; font-size: 70%"}

$$\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*} = \frac{\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}}
{\color{#0074D9}\sum_{\color{#0074D   
9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}}$$

donde:
 
$\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}$ el numerador, es la suma de los valores $x_{i}$ de la unidad espacial de interes con sus vecinos $x_{j}$ &
 
  

 
 $\frac{}{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}}$ el denominador, es la suma de todos los valores $x$ en toda la localidad de interes.
 
**Hotspots** 
son las áreas o las unidades espaciales con valores altos de $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$ y homogéneos de la unidad espaciales de interes $x_{ij}$. En otras palabras el estadístico espacial, identifica las unidades espaciales $x_{ij}$ con valores altos comparados con el valor promedio de todas la unidades espaciales en la localidad de interes.

::: aside

[Getis & Ord 1992](https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1538-4632.1992.tb00261.x); [Ord & Getis 1995](https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1538-4632.1995.tb00912.x)
:::

:::

## [Candenas de Transmisión Knox Test]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">


:::: {.columns}

::: {.column style="width: 50%; font-size: 80%"}
1. Bajar las bases de datos del **[SINAVE](https://www.sinave.gob.mx/)**.
&nbsp;

2. Geocodificar las bases.
&nbsp;

3. Generar la base (onset y coordenadas).
&nbsp;

4. Aplicar el [**Knox test**]().
&nbsp;

5. Definir los [**Space-Time link**]().
&nbsp;

6. Visualizar [**Space-Time link**]().
]
:::


::: {.column style="width: 50%"}

```{r, dpi=300,echo=FALSE, fig.align ="center", out.width = "100%"}
DiagrammeR::grViz("digraph {

  # graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = rectangle, style = filled, color = grey] 
  
  
  
  # edge definition
  edge [color = grey, arrowhead = normal, arrowtail = dot]
  
  # flowchart for sinave
  sinave [label = 'SINAVE',  fillcolor = '#0F9D58', color = 'white', fontcolor = 'white']
  denv [label = 'Bases de DENV',  fillcolor = '#0F9D58', color = 'white', fontcolor = 'white']
  geocode [label = 'Geocodificación',  fillcolor = '#0F9D58', color = 'white', fontcolor = 'white']
 
  
  # knox
  base [label = 'Genera la base (onset-coordenadas)',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
  
  knox [label = 'Knox test',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
  
  time_link [label = 'Space-Time Link',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
  
   vis [label = 'Visualización',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white'] 
  
  # edge definitions with the node IDs
  sinave -> denv -> geocode -> base -> knox -> time_link -> vis
  
   
 
  }", 
  height = 550)

```
:::

::::

::: aside
[Knox, 1963](https://www.jstor.org/stable/25565339);
[Knox & Bartlett, 1964](https://www.jstor.org/stable/2985220)
:::


## [Candenas de Transmisión Knox Test]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

::: {.column style="width: 100%; font-size: 75%"}
$$\color{Orange}{Knox} = \frac{1}{2} \sum_{i=1}^{n}  \sum_{i=1}^{n} \color{Green}{S_{ij}} \color{red}{T_{ij}}$$
donde:

$\color{Green}{S_{ij}}$ = 1 si el caso $( i\ne j)$ & la $d_{ij} \le \delta^s$ (metros = 400), de lo contrario 0.

$\color{red}{T_{ij}}$ = 1 si el caso $( i\ne j)$ & la $d_{ij} \le \delta^t$ (dÍas = 20), de los contrario 0.

**Hipotesis Nula** las distancias temporales entre pares de casos son independientes de las distancias espaciales.

**Hipotesis Alternativa** existe dependencia de las distancias espaciales y temporales entre los pares de casos (existen cadenas de transmisión).

:::

::: aside
[Viet al 2015]()
:::


## [Log-Gaussian Cox Process]{style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

:::: {.columns}

::: {.column style="width: 50%; font-size: 80%"}

1. Bajar las bases de datos del **[SINAVE](https://www.sinave.gob.mx/)**.
&nbsp;

2. Geocodificar las bases.
&nbsp;

3. Aplicar el [**LGCP**]().
&nbsp;

4. Visualizar [**el modelo**]()

:::


::: {.column style="width: 50%"}
```{r, dpi=300,echo=FALSE, fig.align ="center", out.width = "100%"}
DiagrammeR::grViz("digraph {

  # graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = rectangle, style = filled, color = grey] 
  
  
  
  # edge definition
  edge [color = grey, arrowhead = normal, arrowtail = dot]
  
  # flowchart for sinave
  sinave [label = 'SINAVE',  fillcolor = '#0F9D58', color = 'white', fontcolor = 'white']
  denv [label = 'Bases de DENV',  fillcolor = '#0F9D58', color = 'white', fontcolor = 'white']
  geocode [label = 'Geocodificación',  fillcolor = '#0F9D58', color = 'white', fontcolor = 'white']
 
  
  # knox
  lgcp [label = 'LGCP',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
  
 
  
   vis [label = 'Visualización',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white'] 
  
  # edge definitions with the node IDs
  sinave -> denv -> geocode -> lgcp  -> vis
  
   
 
  }", 
  height = 550)

```
:::

::::

::: aside
[Moraga, 2020](https://journal.r-project.org/archive/2021/RJ-2021-017/RJ-2021-017.pdf) 
:::


## [Log-Gaussian Cox Process]{style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">


::: {.column style="width: 100%; font-size: 60%"}
 **Modelo General** 
$$\varLambda{_s} = exp(n{_s})$$
El modelo asume que los casos son una parcial realización de un proceso Gausiano (log-Gaussian).

 **Modelo en un Grid** 
$$\varLambda_{ij} = \int\limits_{s_{ij}}^{} exp(n(s))ds$$
$$\varLambda_{ij} \approx |s_{ij}| exp(n_{ij})$$
donde $|s_{ij}|$ es el área de la celda $s_{ij}$

$y_{ij}|n_{ij} \sim Poisson(|s_{ij}|exp(n_{ij}))$

$n_{ij} = \beta{_0} + \beta{_1} \space x \space cov (s_{ij}) + f{_s}(s_{ij}) + f{_u}(s_{ij})$


:::


## [Análisis Espacial del Vector del Dengue]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

```{r, echo=FALSE, out.width='100%', fig.align='center'}
DiagrammeR::grViz("digraph {
                  # graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = rectangle, 
  style = filled, 
  color = grey, 
  nodesep = .5,
  fixedsize = true, 
  width = 2.5] 
  
  # edge definition
  edge [color = grey, arrowhead = normal, arrowtail = dot]
  
  ##### entomological data
  
  ento [label = 'Vigilancia Entomológica',  fillcolor =  '#FF5A5F', color = 'white', fontcolor = 'white']
  data_historic [label = 'Datos Históricos',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  
  years  [label = '2014-2019',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  data_datos_actuales [label = 'Datos del Año Actual',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  data_acumulados [label = 'Datos hasta la Semana Actual',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  data_trans_activa [label = 'Semana Actual',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  
  
  ##### Spatial Data
  
  geo_data [label = 'Geoestatistical Data',  fillcolor =  '#0F9D58', color = 'white', fontcolor = 'white']
 
  
 
 # Análisis 
 spde [label = 'SPDE-INLA',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 hotspots [label = 'Hotspots Analysis',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 #prediction [label = 'Predicción Espacial de Huevos',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 
 # entomological study
 ovitraps [label = 'Ovitrampas',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
  enc_ver [label = 'Encuesta-Verificación',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
  adults [label = 'Colecta de Adultos',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 
 
 # software
 r_rstudio [label = 'R & RStudio',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']
 deneggs [label = 'deneggs Package',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white'] 
 
 
 
 
 ##### define the relation
 
 
 ento -> {ovitraps  enc_ver adults} 
 
 {ovitraps adults} -> geo_data -> {data_historic data_datos_actuales}
 data_historic -> years
 
 data_datos_actuales -> {data_acumulados data_trans_activa}
 
 {years data_acumulados data_trans_activa} ->spde -> hotspots
 
 {hotspots} -> r_rstudio -> deneggs
 
}")

```


## [Análisis Geoestadístico]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">


:::: {.columns}

::: {.column style="width: 50%"}
![](guadalajara_sample.jpg)
:::

::: {.column style="width: 50%; font-size: 60%"}
$s{_i}$ sitios de colecta con coordenadas geográficas (longitud. latitud).
&nbsp;

$D$ area de estudio (zona metropolitana de Guadalajara).
&nbsp;

$Y{_i}$ es la variable de respuesta (Número de Huevos por Ovitrampa o Manzana).
&nbsp;

$y{_i}$ tiene una distribución (binomial negativa ó zibn).
&nbsp;

$U{_s{_i}}$ el efecto espacial & el proceso ocurre en un campo gaussiano continuo (Gaussian Field).

Se usa SPDE & Elemento Finito para aproximar la matriz de covarianzas de $U{_s{_i}}$

$\color{#2ECC40}{el \space proceso \space se \space encuentra \space implementado \space en \space INLA}$
:::


::::


## [Análisis Espacial del Vector del Dengue]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

```{r, echo=FALSE,dpi=300,  fig.align ="center",out.height="70%", out.width = "90%"}
DiagrammeR::grViz("digraph {

  # graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = rectangle, style = filled, color = grey] 
  
  edge [color = grey, arrowhead = normal, arrowtail = dot]
  #
  cenaprece [label = 'CENAPRECE',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
  ovitrap [label = 'Ovitrampas',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
  coord [label = 'Coordenadas',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
  ovicoord [label = 'ovi + coord']
  
  # flow chart for inegi
  inegi [label = 'INEGI', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  loc [label = 'Localidades Shapefile', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']

  ###
  mesh [label = '1. Mesh']
  spde [label = '2. SPDE']
  
  proj_train [label = '3a. Projector Matrix A. Test']
  proj_test [label = '3b. Projector Matrix A. Train']
  
  spatial_field [label = '4. Spatial Field W']
  
  stack_train [label = '5a. Stack Train']
  stack_test [label = '5b. Stack Test']
  stack_pred [label = '5c. Stack Prediction']
  stack_joint [label = '6. Joint Stack']
  
  formula [label = '7. Formula']
  inla [label = '8. INLA',  fillcolor = 'Orange', color = 'white', fontcolor = 'white']
  
 
  
  # edge definitions with the node IDs
  cenaprece -> {ovitrap, coord} -> ovicoord
  #
  inegi -> loc -> ovicoord
  #
  ovicoord -> mesh
  mesh -> spde -> spatial_field ->  stack_joint
  spde -> {proj_train,  proj_test}
  spatial_field -> {stack_test, stack_train, stack_pred} ->  stack_joint -> formula -> inla 
  proj_train -> stack_train
  proj_test -> stack_test

  
  }", 
  height = 500)

```


::: aside
[Modificado de Zuur et al 2017](http://www.highstat.com/index.php/beginner-s-guide-to-regression-models-with-spatial-and-temporal-correlation); [Dzul-Manzanilla et al 2019](http://acaentmex.org/entomologia/revista/2019/EMF/EMF%20497-501.pdf)
:::


## [Análisis Espacial del Vector del Dengue]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

```{r, echo=FALSE,dpi=300, fig.align ="center", out.height="70%", out.width = "90%"}
DiagrammeR::grViz("digraph {

  # graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = rectangle, style = filled, color = grey] 
  edge [color = grey, arrowhead = normal, arrowtail = dot]
  
  #
  
  inla [label = '8. INLA',  fillcolor = 'Orange', color = 'white', fontcolor = 'white']
  stat [label = '9. Statistics']
  
  zeros [label = '9.1. % Zeros']
  disp [label = '9.2. Dispersion Statistics']
  dic [label = '9.3. Deviance Information Criterio']
  pear [label = '9.4. Pearson Residuals']
  
  ##
  p [label = 'Poisson']
  zip [label = 'ZeroInflated Poisson']
  nb [label = 'Negative Binomial']
  zinb [label = 'ZeroInflated Poisson Negative Binomial']
  
  sel [label = '10.Select the Distribution & Model']
  
  # prediction ####
  ext_pred [label = '11. Extract Index Prediction']
  coor_pred [label = '12. Extract Coordinates Prediction']
  pred [label = '13. Prediction']
 
  hotspots [label = '14.Hotspots', fillcolor = 'Orange', color = 'white', fontcolor = 'white']
  save [label = '15. Save results']
  
  mappred [label = '15a. Prediction Map']
  hotspotsb [label = '15b. Hotspots']
  dics [label = '15c. DICs']
  loc [label = '15d. Locality']
  data [label = '15e. Dataset']
  
  # edge definitions with the node IDs
  inla -> stat
  stat -> {zeros, disp, dic,pear} -> {p, zip, nb, zinb} -> sel
  sel -> ext_pred -> coor_pred -> pred -> hotspots -> save
  save -> {mappred, hotspotsb, dics, loc, data}

  
  }", 
  height = 500)

```


::: aside
[Modificado de Zuur et al 2017](http://www.highstat.com/index.php/beginner-s-guide-to-regression-models-with-spatial-and-temporal-correlation); [Dzul-Manzanilla et al 2019](http://acaentmex.org/entomologia/revista/2019/EMF/EMF%20497-501.pdf)
:::


## [Análisis Espacial del Dengue de México en R]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

Paquetes en R desarrollados por el Programa ([denhotspots](https://fdzul.github.io/denhotspots/) & [deneggs](https://github.com/fdzul/deneggs)) para el análisis espacial.

```{r, echo=FALSE, message=FALSE, warning=FALSE}

tibble::tibble("Análisis"= c("Hotspots",
                             "Visualización de los Hotspots",
                             "Cadenas de Transmisión",
                             "Visualiación de las Cadenas de Transmisión",
                             "LGCP",
                             "Visualización de LGCP",
                             "Hotspots de Huevos",
                             "Visualización de Hotspots"),
               "denhotspots" = c(T,T, T, T,
                                T, T,F, F),
               "deneggs" = c(F, F, F, F,
                             F, F, T, T)) |>
    reactable::reactable(defaultPageSize = 10,
                         theme = reactablefmtr::flatly(),
                         filterable = FALSE,
                         striped = TRUE,
                         #minRows = 10,
                         resizable = TRUE, 
                         wrap = TRUE, 
                         bordered = TRUE)

```


## [Hotspots de la Transmisión de Dengue en ]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

::: {.panel-tabset}

## Datasets
```{r}
#| echo: true
#| output: true
# Step 1. load the dengue geocoded dataset ####
load("~/Dropbox/hotspots_2023/8.RData/denmex.RData")
head(xy)
```

## Localidad

```{r, message=FALSE, warning=FALSE}
#| echo: true
#| output: true
# Step 2. extract the locality #####
x <- rgeomex::extract_ageb(locality = c("Guadalajara", "Zapopan", 
                                        "Tlaquepaque", "Tonalá"), 
                           cve_edo = "14")
head(x)


```

## Casos por AGEB

```{r}
#| echo: true
#| output: true
library(magrittr)
library(sf)
z <- denhotspots::point_to_polygons(x = xy,
                                    y = x$ageb,
                                    ids = names(x$ageb)[-10],
                                    time = ANO,
                                    coords = c("long", "lat"),
                                    crs = 4326,
                                    dis = "DENV") 
head(z)

```

## Hotspots
```{r}
#| echo: true
#| output: true
hotspots <- denhotspots::gihi(x = z,
                              id = names(z)[c(1:9)], 
                              time = "year",
                              dis = "DENV",
                              gi_hi = "gi",
                              alpha = 0.95)
head(hotspots)

```

:::

## [Hotspots de la Transmisión de Dengue en ]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

::: {.panel-tabset}

## Mapa Estático_code

```{r}
#| echo: true
#| output: false
denhotspots::staticmap_intensity(x = hotspots,
                                 pal = rcartocolor::carto_pal,
                                 pal_name = TRUE,
                                 name = "OrYel",
                                 breaks = 1,
                                 dir_pal = -1,
                                 x_leg = 0.5,
                                 y_leg = 0.1,
                                 ageb = TRUE)
```

## Mapa Estático

```{r}
#| echo: false
#| output: true
denhotspots::staticmap_intensity(x = hotspots,
                                 pal = rcartocolor::carto_pal,
                                 pal_name = TRUE,
                                 name = "OrYel",
                                 breaks = 1,
                                 dir_pal = -1,
                                 x_leg = 0.5,
                                 y_leg = 0.1,
                                 ageb = TRUE)
```

:::


## [Hotspots de la Transmisión de Dengue en ]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

::: {.panel-tabset}

## Mapa Interactivo_code

```{r}
#| echo: true
#| output: false
mapview::mapview(hotspots,
                 zcol = "intensity_gi",
                 layer.name = "Intensidad",
                 label = FALSE,
                 color = "white",
                 lwd = 0.5, 
                 col.regions =  rcartocolor::carto_pal(n = max(hotspots$intensity_gi), 
                                                       name = "OrYel"))
```

## Mapa Interactivo

```{r}
#| echo: false
#| output: true
mapview::mapviewOptions(default = TRUE,
                        basemaps.color.shuffle = FALSE)
mapview::mapview(hotspots,
                 zcol = "intensity_gi",
                 layer.name = "Intensidad",
                 label = FALSE,
                 color = "white",
                 lwd = 0.5, 
                 col.regions =  rcartocolor::carto_pal(n = max(hotspots$intensity_gi), 
                                                       name = "OrYel"))
```

:::


## [Modelo Log Gaussian Cox Process]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

::: {.panel-tabset}

## LGCP Mérida code
```{r}
#| echo: true
#| output: false

# Step 1. load the dengue geocoded dataset ####
load("/Users/fdzul/Library/CloudStorage/OneDrive-Personal/proyects/geocoding_mex/2023/9.geocoded_dataset/dengue_mx_2023.RData")

# Step 2. extract the dengue cases #####
geocoded_dataset <- z |>
    dplyr::filter(ESTATUS_CASO == 2) |>
    dplyr::mutate(onset = FEC_INI_SIGNOS_SINT,
                  date = as.character(onset),
                  id = VEC_ID) |>
    dplyr::mutate(x = long,
                  y = lat) |>
    sf::st_as_sf(coords = c("long", "lat"),
                 crs = 4326) |>
    dplyr::select(x, y, onset) 

# Step 3. extract the locality ####
loc <- rgeomex::extract_locality(cve_edo = 31,
                                 locality = "Mérida")


# Step 4. extract the dengue cases of the locality 
geocoded_dataset <- geocoded_dataset[loc,] |>
    sf::st_drop_geometry()


# Step 5. map of lgcp 
x <- denhotspots::spatial_lgcp(dataset = geocoded_dataset,
                           locality = "Merida",
                           cve_edo = "31",
                           longitude = "x",
                           latitude = "y",
                           k = 30,
                           plot = FALSE,
                           aproximation = "gaussian",
                           integration = "laplace",
                           resolution = 0.015,
                           approach = "lattice",
                           cell_size = 1500,
                           name = "YlGnBu")
x$map

```

## LGCP Mérida Mapa
```{r}
#| echo: false
#| output: true


# Step 1. load the dengue geocoded dataset ####
load("/Users/fdzul/Library/CloudStorage/OneDrive-Personal/proyects/geocoding_mex/2023/9.geocoded_dataset/dengue_mx_2023.RData")

# Step 2. extract the dengue cases #####
geocoded_dataset <- z |>
    dplyr::filter(ESTATUS_CASO == 2) |>
    dplyr::mutate(onset = FEC_INI_SIGNOS_SINT,
                  date = as.character(onset),
                  id = VEC_ID) |>
    dplyr::mutate(x = long,
                  y = lat) |>
    sf::st_as_sf(coords = c("long", "lat"),
                 crs = 4326) |>
    dplyr::select(x, y, onset) 

# Step 3. extract the locality ####
loc <- rgeomex::extract_locality(cve_edo = 31,
                                 locality = "Mérida")


# Step 4. extract the dengue cases of the locality 
geocoded_dataset <- geocoded_dataset[loc,] |>
    sf::st_drop_geometry()


# Step 5. map of lgcp 
library(magrittr)
library(ggplot2)
library(sf)
library(sp)
library(plotly)
library(htmlwidgets)

x <- denhotspots::spatial_lgcp(dataset = geocoded_dataset,
                           locality = "Merida",
                           cve_edo = "31",
                           longitude = "x",
                           latitude = "y",
                           k = 30,
                           plot = FALSE,
                           aproximation = "gaussian",
                           integration = "laplace",
                           resolution = 0.015,
                           approach = "lattice",
                           cell_size = 1500,
                           name = "YlGnBu")
x$map
```

:::

## [Modelo Log Gaussian Cox Process]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

::: {.panel-tabset}

## Mapa de Calor Code
```{r}
#| echo: true
#| output: false
# Step 2. load the dengue dataset geocoded ####
load("/Users/fdzul/Library/CloudStorage/OneDrive-Personal/proyects/geocoding_mex/2024/8.RData/denmex_2024.RData")

# step 3. apply the function ####
####
densnv::mp_heatmap(geocoded_dataset = z,
                   cve_edo = "31",
                   locality = c("Mérida"),
                   status_caso = c(1,2),
                   week = 1:3,
                   alpha = 0.6,
                   static = FALSE,
                   palette = viridis::turbo)

```
## Mapa de Calor

```{r}
#| echo: false
#| output: true
# Step 2. load the dengue dataset geocoded ####
load("/Users/fdzul/Library/CloudStorage/OneDrive-Personal/proyects/geocoding_mex/2024/8.RData/denmex_2024.RData")

# step 3. apply the function ####
####
densnv::mp_heatmap(geocoded_dataset = z,
                   cve_edo = "31",
                   locality = c("Mérida"),
                   status_caso = c(1,2),
                   week = 1:3,
                   alpha = 0.6,
                   static = FALSE,
                   palette = viridis::turbo)

```
:::


## [Análisis Geoestadístico del Vector del Dengue]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

::: {.panel-tabset}

## SPDE-INLA code
```{r}
#| echo: true
#| output: false
# Step 1. define the path 
path_ovitraps <- "/Users/fdzul/Library/CloudStorage/OneDrive-Personal/datasets/CENAPRECE/2023/14_jalisco"
path_coord <- paste(path_ovitraps, "DescargaOvitrampasMesFco.txt", sep = "/")
map_gua <- deneggs::eggs_hotspots(path_lect = path_ovitraps,
                        path_coord = path_coord,
                       cve_ent = "14",
                       locality  = c("Guadalajara", "Zapopan",
                                     "Tlaquepaque", "Tonala"),
                       longitude  = "Pocision_X",
                       latitude =  "Pocision_Y",
                       aproximation = "gaussian",
                       integration = "eb",
                       fam = "zeroinflatednbinomial1",
                       k = 40,
                       palette_vir  = "magma",
                       leg_title = "Huevos",
                       plot = FALSE,
                       hist_dataset = FALSE,
                       sem = 40, var = "eggs",
                       cell_size = 5000,
                       alpha = .99)
```


## SPDE-INLA map
```{r}
#| echo: false
#| output: true
map_gua$map
```
:::


## [Análisis Geoestadístico del Vector del Dengue]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

::: {.panel-tabset}

### SPDE-INLA

```{r}
#| echo: false
#| output: true
load("~/Library/CloudStorage/OneDrive-Personal/proyects/talks/reunion_inter_estatal/8.RData/eggs_betas_hotspots_2023_merida.RData")

loc <- rgeomex::extract_locality(cve_edo = "31",
                                 locality = "Merida")
ggplot2::ggplot() +
    ggplot2::geom_tile(data = betas_merida |> 
                           dplyr::filter(week %in% c(5, 15, 25,
                                                    35, 45, 50)),
                       ggplot2::aes(x = x,
                                    y = y,
                                    fill = pred_mean)) +
    ggplot2::scale_fill_viridis_c("Huevos",
                                  option = "viridis") +
    ggplot2::geom_sf(data = loc,
                     fill = NA,
                     col = "black", 
                     lwd = 1.5) +
    ggplot2::theme_void() +
    ggplot2::facet_wrap(facets = "week")
```

### Intensidad 2023
```{r}
#| echo: false
#| output: true
deneggs::map_eggs_hotspots(betas = betas_merida,
                           locality = "Merida",
                           cve_edo = "31",
                           palette = rcartocolor::carto_pal,
                           name = "SunsetDark")
```

:::


## [Modelo de Estratificación del Riesgo de Transmisión de Dengue]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

:::: {.columns}

::: {.column style="width: 50%"}
Concepto
<img src = "fig/stacked_maps_cases.jpg">
:::

:::{.column style="width: 50%"}
Mapa de riesgo
<img src = "fig/map_risk_guadalajara.jpg">
:::

::::


## [Dios Botic]{style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">


-   ***Bio*** : [https://fdzul.github.io/web_site_fadm/]()

-   ***email*** : [felipe.dzul.m@gmail.com]()

-   ***celular*** : [9999580167]()

-   ***slides***: [https://calm-hummingbird-41cb33.netlify.app/talks/spatial_analysis_dengue/#/](https://calm-hummingbird-41cb33.netlify.app/talks/spatial_analysis_dengue/#/)
