---
format: 
  revealjs:
    code-block-bg: true
    code-block-background: true
    code-copy: true
    chalkboard: true
    highlight-style: github
    slide-number: c/t
    logo: logo_cenaprece.jpeg
    footer: "[hub.com/fdzul](https://github.com/fdzul)"
    center-title-slide: true
---

<h2> Hotspots de la Transmisión de Dengue
<br>
</h2>

<h2>

</h2>

<hr>

<br>


<h3>Dr. Felipe Dzul Manzanilla</h3>

<h3>Dr. Fabián Correa-Morales</h3>

<h3>

</h3>
<br>
<h4>Date: 2024-01-26 </h4>

<h4> Update: 2024-01-26</h4>

<br>

<h4>


![](logo_curso_2024.png){.absolute top="170" left="650" width="450"}


## [Temario]{style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

- Ciclo del vida del programa de Dengue
- Línea de Tiempo de la Vigilancia Epidemiológica & Entomológica
- Flujograma del Análisis Espacial del Dengue en R
- Algoritmo de los Hotspots de la Transmisión del Dengue
- Estadísdico Espacial Local $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$.
- Calculo del Estadísdico Espacial Local $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$

## [Ciclo del Vida del Programa del Dengue]{style="color:#003300;" .r-fit-text}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

```{r, dpi=300,echo=FALSE, fig.align ="center", out.height="100%",out.width = "100%"}
DiagrammeR::grViz("digraph {

  # graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = circle, style = filled, color = grey,
  fixedsize = true, width = 2] 
  edge [color = grey, arrowhead = normal, arrowtail = dot]
  
  
  ###########
  prog_den [label = 'Programa de Dengue',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']
  
  # epidemiology
  epi [label = 'Vigilancia Epidemiológica',  fillcolor = '#0F9D58', color = 'white', fontcolor = 'white']
  
  brote [label = 'Brote',  fillcolor = 'DarkOrange', color = 'white', fontcolor = 'black']
  cp [label = 'Control de Probables',  fillcolor = 'DarkOrange', color = 'white', fontcolor = 'black']
  node [shape = circle, style = filled, color = grey] 
  
  
  node [shape = circle, style = filled, color = grey] 
  
  
  hotspots [label = 'Hotspots',  fillcolor = '#DB4437', color = 'white', fontcolor = 'white']
  cadenas [label = 'Cadenas de Transmisión',  fillcolor = '#DB4437', color = 'white', fontcolor = 'white']
  
  heatmap [label = 'Mapas de Calor',  fillcolor = '#DB4437', color = 'white', fontcolor = 'white']
  node [shape = circle, style = filled, color = grey] 
  
  
  #### entomology
  ent [label = 'Vigilancia Entomológica',  fillcolor = '#0F9D58', color = 'white', fontcolor = 'white']
  ovitraps [label = 'Ovitrampas',  fillcolor = 'DarkOrange', color = 'white', fontcolor = 'white']
  adult [label = 'Colecta de Adultos*',  fillcolor = 'DarkOrange', color = 'white', fontcolor = 'white']
  enc_ver [label = 'Encuesta Verificación',  fillcolor = 'DarkOrange', color = 'white', fontcolor = 'white']
  
  
  plat [label = 'Plataforma',  fillcolor = 'DarkOrange', color = 'white', fontcolor = 'black']
  
  #########
 
  ###
  ind [label = 'Indicadores',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
  
  ###################
  prog_den -> {epi, ent}[penwidth = 4]
  
  
  epi -> {brote[arrowhead = crow, arrowtail = box, color = 'Maroon']
  cp[arrowhead = crow, arrowtail = box, color = 'Maroon']
  hotspots[arrowhead = crow, arrowtail = box, color = 'Maroon']
  cadenas[arrowhead = crow, arrowtail = box, color = 'Maroon']
  heatmap[arrowhead = crow, arrowtail = box, color = 'Maroon']
  
  
  } -> plat[penwidth = 4]
  epi -> {}[penwidth = 4]
  ent -> {adult, ovitraps, enc_ver} -> plat[penwidth = 4]  
  plat -> ind[penwidth = 4]
 

 
 
 
  }", 
  height = 550)

```



## [Linea de Tiempo de la Vigilancia Epidemiológica & Entomológica]{style="color:#003300;" .r-fit-text}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

```{r,dpi=300, echo=FALSE, fig.align ="center", out.height="100%", out.width = "100%", warning=FALSE, message=FALSE}
library(timevis)
a <- timevis::timevis(data = data.frame(start = c("2008-01-01", 
                                                  "2011-01-01",
                                                  "2017-01-01",
                                                  "2017-01-01",
                                                  "2008-01-01",
                                                  "2021-01-01", 
                                                  "2021-03-01"),
                                        end = c(Sys.Date(), 
                                                Sys.Date(), 
                                                Sys.Date(),
                                                Sys.Date() , 
                                                Sys.Date(), 
                                                Sys.Date(), 
                                                Sys.Date()),
                          content = c("Vigilancia Epidemiológica Pasiva", 
                                      "Vigilancia Entomológica con Ovitrampas", 
                                      "Vigilancia Entomológica con Adultos",
                                      "Entomovirología",
                                      "Hotspots Históricos",
                                      "Actuales (clusters de casos y cadenas de transmisión)",
                                      "Transmisión Activa (Identificación de cadenas de transmisión: knox test)"),
                          #type = c("background"),
                          style = c("text-align: center; font-weight: bold; color: white; font-size: 12px; border-color: #DB4437; border: 2px solid white; background-color: #DB4437;",
                                    "text-align: center; font-weight: bold; color: white; font-size: 12px; border-color: #4285F4; border: 2px solid white; background-color: #4285F4;",
                                    "text-align: center; font-weight: bold; color: white; font-size: 12px; border-color: #4285F4; border: 2px solid white; background-color: #4285F4;", 
                                    "text-align: center; font-weight: bold; color: white; font-size: 12px; border-color: #0F9D58; border: 2px solid white; background-color: #0F9D58;",
                                    "text-align: center; font-weight: bold; color: white; font-size: 12px; border-color: #F4B400; border: 2px solid white; background-color: #F4B400;", 
                                    "text-align: left; font-weight: bold; color: white; font-size: 12px; border-color: #F4B400; border: 2px solid white; background-color: #F4B400;", 
                                    "text-align: righ; font-weight: bold; color: white; font-size: 12px; border-color: #F4B400; border: 2px solid white; background-color: #F4B400;"),
                          group = c(1, 2, 2,3, 4, 4,4)),
        groups = data.frame(id = 1:4, 
                            content = c("Paciente", 
                                        "Vector",
                                        "Virus-Vector",
                                        "Análisis espacial"),
                            style = c("text-align: center; font-weight: bold; color: white; font-size: 15px; border-color: #DB4437; border: 2px solid white; background-color: #DB4437;",
                                      "text-align: center; font-weight: bold; color: white; font-size: 15px; border-color: #4285F4; border: 2px solid white; background-color: #4285F4;",
                                      "text-align: center; font-weight: bold; color: white; font-size: 15px; border-color: #0F9D58; border: 2px solid white; background-color: #0F9D58;",
                                      "vertical-align: middle; text-align: center; font-weight: bold; color: white; font-size: 20px; border-color: #F4B400; border: 2px solid white; background-color: #F4B400;")))

a


style <- "
.vis-time-axis { 
background-color: lightgray;
backgroud-border: 3px solid #73AD21;
backgroun-opacity; 0.1;
font-weight: bold;
text-align: center;
vertical-align: middle;
border: 1.5px solid #73AD21;
font-size: 15px;}
.vis-odd {
color: blue;
vertical-align: middle;
  }

"
htmltools::html_print(htmltools::tagList(htmltools::tags$style(style), a))

```

## [Fllujograma del Análisis Espacial de la Transmisión del Dengue]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

```{r, echo=FALSE, out.width='100%', fig.align='center'}
DiagrammeR::grViz("digraph {
                  # graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = rectangle, 
  style = filled, 
  color = grey, 
  nodesep = .5,
  fixedsize = true, 
  width = 2.5] 
  
  # edge definition
  edge [color = grey, arrowhead = normal, arrowtail = dot]
  
  ##### epidemiological data
  
  epi [label = 'Vigilancia Epidemiológica',  fillcolor =  '#DB4437', color = 'white', fontcolor = 'white']
  data_historic [label = 'Datos Históricos',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  data_datos_actuales [label = 'Datos Actuales',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  data_acumulados [label = 'Datos Acumulados',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  data_trans_activa [label = 'Transmisión Activa',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  
  
  ##### Spatial Data
  
  areal [label = 'Areal Data',  fillcolor =  '#0F9D58', color = 'white', fontcolor = 'white']
  pp_data [label = 'Point Pattern Data',  fillcolor =  ' #0F9D58', color = 'white', fontcolor = 'white']
  
  
 
 # Análisis 
 hotspots [label = 'Hotspots Analysis',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 cadenas [label = 'Cadenas de Transmisión',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 cluster_ana [label = 'Cluster Analysis',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 lgcp [label = 'Spatial LGCP',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 
 heatmap [label = 'Mapas de Calor',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 
 
 # software
 
 geoda [label = 'Geoda',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']
 cluster_s [label = 'ClusterSeer',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']
 satscan [label = 'SatScan',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']
 
 r_rstudio [label = 'R & RStudio',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']

  denhotspot [label = 'denhotspots Package',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white'] 
 
 ##### define the relation
 
 epi -> {data_historic  data_datos_actuales}
 data_historic -> areal -> hotspots -> geoda
 data_datos_actuales -> {data_acumulados, data_trans_activa} -> pp_data -> {cadenas lgcp cluster_ana heatmap}
 cadenas -> cluster_s
 cluster_ana -> satscan
 
 {geoda cluster_s satscan lgcp} -> r_rstudio -> denhotspot
 
}")

```

## [Hotspots de la Transmisión del Dengue]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

:::: {.columns}

::: {.column style="width: 50%; font-size: 60%"}
1. Bajar las bases de datos del [SINAVE](https://www.sinave.gob.mx/).
2. Geocodificar las bases.
3. Bajar los shapefile del [INEGI](https://www.inegi.org.mx/).
4. Seleccionar la localidad de interes y extraer los AGEBs.
5. Contar el número de casos por AGEB.
6. Cálcular el Z-score de los casos.
7. Generar la matriz de adjacencias.
8. Cálcular el estadístico espacial local Getis&Ord $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$.
9. Realizar la la corrección de Bonferroni.
10. Cálcular los hotspots.
11. Visualizar los hotspots.
:::

::: {.column style="width: 50%"}

```{r, dpi=300,echo=FALSE, fig.align ="center", out.width = "100%"}
DiagrammeR::grViz("digraph {

  # graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = rectangle, style = filled, color = grey] 
  
  # flowchart for hotspots
  sinave [label = 'SINAVE',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
  denv [label = 'Bases de DENV',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
  geocode [label = 'Geocodificación',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
  cases_ageb [label = 'Casos por AGEBs']
  z_score [label = 'Z-score']
  gi [label = 'Estadístico Espacial Local (Gi*)']
  bonferroni [label = 'Corrección de Bonferroni']
  hotspots [label = 'Hotspots', style = filled, color = orange]
  
  # flow chart for inegi
  inegi [label = 'INEGI', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  loc [label = 'Localidades Shapefile', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  ageb [label = 'AGEB Shapefile', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  loc_esp [label = 'Localidad de Ínteres', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  ageb_esp [label = 'AGEBs de la Localidad de Ínteres', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  mat [label = 'Matriz de Adjacencias', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  
  # edge definitions with the node IDs
  edge [color = black]
  sinave -> denv -> geocode -> cases_ageb -> z_score -> gi -> bonferroni -> hotspots 
  inegi -> {ageb, loc}
  loc -> loc_esp -> ageb_esp
  ageb -> ageb_esp
  ageb_esp -> mat
  mat -> cases_ageb 
 
  }", 
  height = 550)

```
:::

::::

::: aside
[Dzul-Manzanilla et al 2021](https://www.thelancet.com/journals/lanplh/article/PIIS2542-5196(21)00030-9/fulltext)
:::


## [Estadístico Espacial Local $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$ (Hotspots)]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

::: {.column style="width: 100%; font-size: 70%"}

$$\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*} = \frac{\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}}
{\color{#0074D9}\sum_{\color{#0074D   
9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}}$$

donde:
 
$\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}$ el numerador, es la suma de los valores $x_{i}$ de la unidad espacial de interes con sus vecinos $x_{j}$ & $\frac{}{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}}$ el denominador, es la suma de todos los valores $x$ en toda la localidad de interes.
 
**Hotspots** 
son las áreas o las unidades espaciales con valores altos de $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$ y homogéneos de la unidad espaciales de interes $x_{ij}$. En otras palabras el estadístico espacial, identifica las unidades espaciales $x_{ij}$ con valores altos comparados con el valor promedio de todas la unidades espaciales en la localidad de interes.

::: aside

[Getis & Ord 1992](https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1538-4632.1992.tb00261.x); [Ord & Getis 1995](https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1538-4632.1995.tb00912.x)
:::

:::



## [Cálculo del estadístico Espacial Local $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

```{r, echo=FALSE,dpi=300, warning = FALSE,message = FALSE,out.width = "80%"}
# Step 2. load the locality ####
x <- rgeomex::extract_ageb(locality = "Homun", 
                           cve_edo = "31")

#  Step 2. simulate dengue cases ####
set.seed(123456)
x$ageb$n <- MASS::rnegbin(n = nrow(x$ageb),
                             mu = 10,
                             theta = 0.2)
row.names(x$ageb) <- stringr::str_sub(row.names(x$ageb),
                                      start = 3,
                                      end = -1)
# Step 4. mapa de cases #####
library(ggplot2)
ggplot2::ggplot() +
    ggplot2::geom_sf(data = x$locality,
                     ggplot2::aes(fill = NULL),
                     lwd = 1,
                     color = "black") +
    ggplot2::geom_sf(data = x$ageb,
                     ggplot2::aes(fill = as.factor(n)),
                     color = "white",
                     lwd = 0.1,
                     label = rownames(x$ageb)) +
    ggplot2::scale_fill_viridis_d("Casos") +
    ggplot2::theme_void() +
    ggplot2::geom_sf_label(data = x$ageb,
                           ggplot2::aes(label = paste(rownames(x$ageb),
                                                      paste("(", x$ageb$n, ")", 
                                                            sep = ""),
                                                      sep= " ")),
                           label.size = 0.1,
                           size = 2.5,
                           alpha = 0.5) +
    ggplot2::ggtitle("Homun, Yuc.")

```


## [Cálculo del estadístico Espacial Local $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">
:::: {.columns}

::: {.column style="width: 40%; font-size: 80%"}
$$\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*} = \frac{\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}}
{\color{#0074D9}\sum_{\color{#0074D   
9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}}$$

donde:
 
$\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}$ el numerador, es la suma de los valores $x_{i}$ de la unidad espacial de interes con sus vecinos $x_{j}$ & $\frac{}{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}}$ el denominador, es la suma de los valores $x$ en toda la localidad de interes.
:::
::: {.column style="width: 60%; font-size: 80%"}

Spatial Weight Matrix $\color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}$
```{r swm, echo=FALSE, warning = FALSE,message = FALSE, fig.align ="left", out.width = "50%"}

# Create the neighborhoods ####
nb_q <- spdep::nb2listw(spdep::poly2nb(x$ageb), 
                        style="B", 
                        zero.policy=TRUE)

# Crate the matrix ####
library(Matrix)
library(spatialreg)
matrix <- as(as(nb_q, "CsparseMatrix"), "matrix")
df <- as.data.frame(matrix)
kableExtra::kbl(df) %>%
  kableExtra::kable_styling(bootstrap_options = "striped", 
                            full_width = T, 
                            font_size = 20)
```

Casos por cada unidad espacial $\color{#FF4136}x_{\color{#FF4136}i}$
```{r swm_casos, echo=FALSE, warning = FALSE,message = FALSE, fig.align ="left", out.width = "50%"}
y_matriz <- matrix(data = x$ageb$n,
                   nrow = 1, 
                   ncol = nrow(x$ageb))
colnames(y_matriz) <- row.names(y_matriz)
dimnames(y_matriz) <- list("casos", row.names(x$ageb))

kableExtra::kbl(y_matriz) |>
  kableExtra::kable_styling(bootstrap_options = "striped", 
                            full_width = T, 
                            font_size = 20)
```
:::
::::


## [Cálculo del estadístico Espacial Local $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

::: {.column style="width: 100%; font-size: 75%"}
$$\color{#2ECC40}{G_{248}^{*}}= \frac{\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}}
{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}} = \frac{\color{#FF4136}{17 +1+ 1 + 0 + 0 +0 +0 +0 +0}}{\color{#0074D9}{17 + 1 + 1 + 5 + 148 +37 + 0 + 0}} = \frac{\color{#FF4136}{9}}{\color{#0074D9}{209}}= \color{#2ECC40}{0.0430622}$$

$$ \color{#2ECC40}{G_{249}^{*}} = \frac{\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}}
{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}} = \frac{\color{#FF4136}{17 + 1 + 1 + 5 + 0 + 37 + 0+ 0}}{\color{#0074D9}{17 + 1 + 1 + 5 + 148 +37 + 0 + 0}} =  \frac{\color{#FF4136}{61}}{\color{#0074D9}{209}} =\color{#2ECC40}{0.291866}$$

$$\color{#2ECC40}{G_{250}^{*}} = \frac{\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}}
{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}} = \frac{\color{#FF4136}{17 + 1 + 1 + 0 +0 + 0 + 0 + 0}}{\color{#0074D9}{17 + 1 + 1 + 5 + 148 +37 + 0 + 0}} =  \frac{\color{#FF4136}{19}}{\color{#0074D9}{209}} =\color{#2ECC40}{0.09090909}$$

$$\color{#2ECC40}{G_{251}^{*}} = \frac{\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}}
{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}} = \frac{\color{#FF4136}{0 + 1 +0 + 5 + 0 + 37 + 0 + 0 }}{\color{#0074D9}{17 + 1 + 1 + 5 + 148 +37 + 0 + 0}} =  \frac{\color{#FF4136}{43}}{\color{#0074D9}{209}} =\color{#2ECC40}{0.2057416}$$

:::


## [Cálculo del estadístico Espacial Local $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

::: {.column style="width: 100%; font-size: 75%"}
$$\color{#2ECC40}{G_{252}^{*}} = \frac{\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}}
{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}} = \frac{\color{#FF4136}{0 + 0 + 0 + 0 + 148 + 37 + 0 + 0}}{\color{#0074D9}{17 + 1 + 1 + 5 + 148 +37 + 0 + 0}} =  \frac{\color{#FF4136}{185}}{\color{#0074D9}{209}} =\color{#2ECC40}{0.8851675}$$

$$\color{#2ECC40}{G_{253}^{*}} = \frac{\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}}
{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}} = \frac{\color{#FF4136}{0 + 1 + 0 + 5 + 148 + 37 + 0 + 0}}{\color{#0074D9}{17 + 1 + 1 + 5 + 148 +37 + 0 + 0}} =  \frac{\color{#FF4136}{191}}{\color{#0074D9}{209}} =\color{#2ECC40}{0.095072181}$$


$$\color{#2ECC40}{G_{254}^{*}} = \frac{\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}}
{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}} = \frac{\color{#FF4136}{0 + 1 + 1 + 148 + 0 + 37 + 0 + 0 }}{\color{#0074D9}{17 + 1 + 1 + 5 + 148 +37 + 0 + 0}} =  \frac{\color{#FF4136}{187}}{\color{#0074D9}{209}} =\color{#2ECC40}{0.8947368}$$


$$\color{#2ECC40}{G_{255}^{*}} = \frac{\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}}
{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}} = \frac{\color{#FF4136}{0 + 0 + 0 + 0 + 0 + 0 + 0 + 0}}{\color{#0074D9}{17 + 1 + 1 + 5 + 148 +37 + 0 + 0}} =  \frac{\color{#FF4136}{0}}{\color{#0074D9}{209}} =\color{#2ECC40}{0.0000000}$$
:::

## [Cálculo del estadístico Espacial Local $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

:::: {.columns}
::: {.column style="width: 60%; font-size: 80%"}
```{r, echo=FALSE}
x$ageb |>
    dplyr::select(n) |>
    sf::st_drop_geometry() |>
    dplyr::mutate(wx = c(2, 61, 19, 43, 185, 191, 187, 0)) |>
    dplyr::mutate(gi = round(wx/sum(n),digits = 3)) |>
    #dplyr::mutate(gi_star = round((n+wx)/sum(n),digits = 3)) |>
    dplyr::mutate(gi_z = round((gi-mean(gi))/sd(gi),
                                  digits = 3)) |>
    kableExtra::kbl() |>
    kableExtra::kable_styling(bootstrap_options = "striped", 
                              full_width = T, 
                              font_size = 35)
```
:::
::: {.column style="width: 40%"}
Corrección de Bonferroni: 

$1-\alpha = (1-\alpha)^{n}$

$n = 8$

$alpha = c(.95, 0.99)$

```{r, echo=FALSE}
 getis_ord_umbral <- function(n, alpha){
        round(qnorm(p = -((1-alpha)/n) + 1, mean = 0, sd = 1), digits = 4)
 }
getis_ord_umbral(n = c(8), alpha = c(.95, .99))
```

:::
::::


## [Distribución de Casos por AGEB]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">
```{r, echo = FALSE}
locality <- rgeomex::extract_locality(cve_edo = "12",
                                      locality = "Acapulco de Juarez")

denmex::den_hotspots[locality, ] |>
    dplyr::select(c(dplyr::starts_with("DENV"))) |>
    tidyr::pivot_longer(cols = dplyr::starts_with("DENV_")) |>
    tidyr::separate(col = name,
                    into = c(NA, "year")) |>
    ggplot2::ggplot() +
    ggplot2::geom_sf(ggplot2::aes(fill = value),
                     color = "gray80") +
    ggplot2::facet_wrap(facets = "year") +
    fishualize::scale_fill_fish(discrete = FALSE,  
                                option = "Hypsypops_rubicundus") +
    cowplot::theme_map()
```


## [Casos por AGEB]{style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

```{r, echo=FALSE, warning = FALSE,message = FALSE, fig.align ="center"}
locality <- rgeomex::extract_locality(cve_edo = "12",
                                      locality = "Acapulco de Juarez")

z <- denmex::den_hotspots[locality, ] |>
    sf::st_drop_geometry() |>
    dplyr::select(c(dplyr::starts_with("DENV")))

names(z) <- unlist(stringr::str_extract_all(names(z),
                                            pattern = "[[:digit:]]{4}"))

z |>
    #head(n = 30) |>
    kableExtra::kable() |>
     kableExtra::kable_styling(bootstrap_options = "striped", 
                              full_width = T, 
                              font_size = 20) |>
    kableExtra::scroll_box(width = "100%", 
                           height = "550px")

```


## [Cálculo del Estadístico Espacial Local $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

```{r,  echo=FALSE, warning = FALSE,message = FALSE, fig.align ="center"}

load("/Users/fdzul/Dropbox/r_developments/r_talks/test_dengue_spatial_analysis/RData/acapulco_getis.RData")

# Getis ####
getis <- hotspots |>
    dplyr::select(dplyr::starts_with("getis_"))
names(getis) <- unlist(stringr::str_extract_all(names(getis),
                                             pattern = "[[:digit:]]{4}"))

getis |>
    round(digits = 3) |>
    knitr::kable() |>
    kableExtra::kable_styling(bootstrap_options = "striped", 
                              full_width = T, 
                              font_size = 20) |>
    kableExtra::scroll_box(width = "100%", 
                           height = "550px")
    

```

## [Hotspots e Intensidad]{ style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

```{r}

load("/Users/fdzul/Dropbox/r_developments/r_talks/test_dengue_spatial_analysis/RData/acapulco_getis.RData")
hotspots <- hotspots |>
    dplyr::select(dplyr::starts_with("hotspots"))

names(hotspots) <- unlist(stringr::str_extract_all(names(hotspots),
                          pattern = "[[:digit:]]{4}"))
    
hotspots |>
    dplyr::mutate(Intensidad = rowSums(hotspots)) |>
    dplyr::filter(!is.na(Intensidad)) |>
    dplyr::arrange(dplyr::desc(Intensidad)) |>
    kableExtra::kable() |>
    kableExtra::kable_styling(bootstrap_options = "striped", 
                              full_width = T, 
                              font_size = 20) |>
     kableExtra::scroll_box(width = "100%", 
                            height = "550px" )
```

## [Intensidad de la Transmisión de Dengue]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

```{r}
#| column: screen
mapview::mapviewOptions(default = TRUE,
                        basemaps.color.shuffle = FALSE)
# Step 1. extract the locality ####
loc <- rgeomex::extract_locality(cve_edo = "12", 
                                 locality = "Acapulco de Juarez")

# Step 2. Extract the hotspots ####
hotspots <- denmex::den_hotspots[loc, ]
mapview::mapview(hotspots,
                 zcol = "intensity_gi",
                 layer.name = "Intensidad",
                 label = FALSE,
                 color = "white",
                 lwd = 0.5, 
                 col.regions =  rcartocolor::carto_pal(n = max(hotspots$intensity_gi), 
                                                       name = "OrYel"))

```

## [Intensidad de la Transmisión de Dengue]{.r-fit-text style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

```{r}
#| column: screen
mapview::mapviewOptions(default = TRUE,
                        basemaps.color.shuffle = FALSE)
# Step 1. extract the locality ####
loc <- rgeomex::extract_locality(cve_edo = "14", 
                                 locality = c("Guadalajara",
                                              "Zapopan",
                                              "Tlaquepaque",
                                              "Tonala"))

# Step 2. Extract the hotspots ####
hotspots <- denmex::den_hotspots[loc, ]
mapview::mapview(hotspots,
                 zcol = "intensity_gi",
                 layer.name = "Intensidad",
                 label = FALSE,
                 color = "white",
                 lwd = 0.5, 
                 col.regions =  rcartocolor::carto_pal(n = max(hotspots$intensity_gi), 
                                                       name = "OrYel"))

```



## [Dios Botic]{style="color:#003300;"}
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

-   ***Bio*** : [https://fdzul.github.io/web_site_fadm/]()

-   ***email*** : [felipe.dzul.m\@gmail.com]()

-   ***celular*** : [9999580167]()

-   ***slides***: [https://calm-hummingbird-41cb33.netlify.app/talks/hotspots_cases/#/](https://calm-hummingbird-41cb33.netlify.app/talks/hotspots_cases/#/)
